{{define "content"}}
<div>
    <div class="mb-1">
        <a href="/orgs/{{.Data.OrgID}}/projects" class="link">&larr; Back to Projects</a>
    </div>

    <div class="page-header mb-2">
        <div>
            <h2 class="mb-1">{{.Data.ProjectName}} Settings</h2>
            <p class="text-muted mb-0">Manage settings for this project</p>
        </div>
        <a href="/orgs/{{.Data.OrgSlug}}/projects/{{.Data.ProjectSlug}}/flakes" class="btn btn-primary">View Flaky Tests</a>
    </div>

    {{if .Error}}
    <div class="error">{{.Error}}</div>
    {{end}}

    {{if .Success}}
    <div class="success">{{.Success}}</div>
    {{end}}

    <section class="mb-2">
        <h3>Project Details</h3>
        <div class="card">
            <div class="card-row">
                <div>
                    <div class="mb-1"><strong>Name:</strong> {{.Data.ProjectName}}</div>
                    <div class="text-muted mb-1">Slug: <span class="code-pill">{{.Data.ProjectSlug}}</span></div>
                    <div class="text-muted">Default branch: <span class="code-pill">{{.Data.DefaultBranch}}</span></div>
                </div>
            </div>
        </div>
    </section>

    <section class="mb-2">
        <h3>API Keys</h3>

        {{if .Data.CanMutate}}
        <details class="mb-1">
            <summary>Create API Key</summary>
            <div class="card mt-1">
                <form method="POST" action="/api/v1/projects/{{.Data.ProjectID}}/api-keys" data-json-form data-token-target="#newApiKeyToken" data-token-reveal="#newApiKeyCard">
                    <input type="hidden" name="_csrf" value="{{.CSRFToken}}">

                    <div class="form-group">
                        <label for="key_name">Key Name</label>
                        <input type="text" id="key_name" name="name" required placeholder="github-actions-uploader">
                    </div>

                    <div class="form-group">
                        <label>Scopes</label>
                        <label>
                            <input type="checkbox" name="scopes" value="ingest:write" checked>
                            ingest:write
                        </label>
                        <label>
                            <input type="checkbox" name="scopes" value="read:project">
                            read:project
                        </label>
                        <small class="helper-text">Ingest requires ingest:write.</small>
                    </div>

                    <div class="button-row">
                        <button type="submit" class="btn btn-primary">Generate Key</button>
                    </div>
                </form>
            </div>
        </details>

        <div id="newApiKeyCard" class="card hidden mb-1">
            <h3 class="mb-1">API Key Created</h3>
            <p class="text-muted mb-1">Save this key now - you won't be able to see it again.</p>
            <pre id="newApiKeyToken" class="code-block"></pre>
            <div class="button-row mt-1">
                <a href="/orgs/{{.Data.OrgID}}/projects/{{.Data.ProjectID}}/settings" class="btn btn-secondary btn-sm">Reload Settings</a>
            </div>
        </div>
        {{end}}

        {{if .Data.APIKeys}}
        <div class="card-grid">
            {{range .Data.APIKeys}}
            <div class="card">
                <div class="card-row">
                    <div>
                        <h3 class="mb-1">{{.Name}}</h3>
                        <div class="text-muted mb-1">
                            Scopes:
                            {{range $i, $s := .Scopes}}{{if $i}}, {{end}}<span class="code-pill">{{$s}}</span>{{end}}
                        </div>
                        <div class="text-muted mb-1">Created: {{.CreatedAt.Format "2006-01-02 15:04"}}</div>
                        <div class="text-muted">
                            Last used:
                            {{if .LastUsedAt}}{{.LastUsedAt.Format "2006-01-02 15:04"}}{{else}}&mdash;{{end}}
                            {{if .RevokedAt}} | <strong>Revoked</strong>{{end}}
                        </div>
                    </div>
                    <div>
                        {{if not .RevokedAt}}
                        {{if $.Data.CanMutate}}
                        <form method="POST" action="/api/v1/projects/{{$.Data.ProjectID}}/api-keys/{{.ID}}" data-json-form data-confirm="Revoke this API key?" data-reload="true">
                            <input type="hidden" name="_csrf" value="{{$.CSRFToken}}">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit" class="btn btn-danger btn-sm">Revoke</button>
                        </form>
                        {{end}}
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="empty-state">
            <p class="mb-0">No API keys yet.</p>
        </div>
        {{end}}
    </section>

    <section>
        <h3>Slack Integration</h3>

        {{if .Data.SlackWebhookURLSet}}
        <div class="card mb-1">
            <div class="text-muted">
                Webhook URL set. Notifications:
                {{if .Data.SlackEnabled}}<strong>enabled</strong>{{else}}<strong>disabled</strong>{{end}}
            </div>
        </div>
        {{else}}
        <div class="empty-state mb-1">
            <p class="mb-0">Slack integration not configured.</p>
        </div>
        {{end}}

        {{if .Data.CanMutate}}
        <details class="mb-1">
            <summary>{{if .Data.SlackWebhookURLSet}}Update Slack Webhook{{else}}Configure Slack{{end}}</summary>
            <div class="card mt-1">
                <form method="POST" action="/api/v1/projects/{{.Data.ProjectID}}/slack" data-json-form data-reload="true">
                    <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
                    <input type="hidden" name="_method" value="PUT">

                    <div class="form-group">
                        <label for="webhook_url">Slack Webhook URL</label>
                        <input type="text" id="webhook_url" name="webhook_url" required placeholder="https://hooks.slack.com/services/...">
                        <small class="helper-text">The API will never echo the full URL back.</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="enabled" checked>
                            Enable notifications
                        </label>
                    </div>

                    <div class="button-row">
                        <button type="submit" class="btn btn-primary">Save Slack Settings</button>
                    </div>
                </form>
            </div>
        </details>

        {{if .Data.SlackWebhookURLSet}}
        <form method="POST" action="/api/v1/projects/{{.Data.ProjectID}}/slack" data-json-form data-confirm="Remove Slack integration?" data-reload="true">
            <input type="hidden" name="_csrf" value="{{.CSRFToken}}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-danger">Remove Slack Integration</button>
        </form>
        {{end}}
        {{end}}
    </section>
</div>
{{end}}
